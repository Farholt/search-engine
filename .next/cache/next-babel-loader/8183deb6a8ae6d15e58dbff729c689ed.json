{"ast":null,"code":"const sqlite3 = require('sqlite3');\n\nconst sqlite = require('sqlite');\n/**\r\n * Calculating weighted score\r\n * @param a \r\n */\n\n\nconst weightedScore = async (a, score) => {\n  let arr = [];\n\n  for (let i = 0; i < a.length; i++) {\n    let wScore = a[i]['rating'] * score;\n    arr.push({\n      movieId: a[i]['rating'],\n      title: a[i]['title'],\n      wScore: wScore\n    });\n  }\n\n  return arr;\n};\n/**\r\n * Calculating euclidean score\r\n * @param a \r\n * @param b \r\n */\n\n\nconst euclideanUser = async (a, b) => {\n  let sim = 0; // integer\n\n  let n = 0; //  counter for number of matching products\n\n  for (let i = 0; i < a.length; i++) {\n    for (let j = 0; j < b.length; j++) {\n      if (a[i]['movieId'] == b[j]['movieId']) {\n        sim += (a[i]['rating'] - b[j]['rating']) ** 2;\n        n += 1;\n      }\n    }\n  }\n\n  if (n == 0) {\n    return 0;\n  }\n\n  let inv = 1 / (1 + sim);\n  return (Math.round(inv * 100) / 100).toFixed(2); // return inv;\n};\n\nconst euclideanAPI = async (req, res) => {\n  const id = req.query.id; // main user\n\n  /* DB connection */\n\n  const db = await sqlite.open({\n    filename: './mydb.sqlite',\n    driver: sqlite3.Database\n  });\n  /* sql */\n\n  let user = await db.all('SELECT * FROM users where id = ?', [id]);\n  /* Retrieve ratings that belongs to main user */\n\n  let userRatings = await db.all('SELECT userId, movies.title, movieId, ratings.rating FROM ratings, users, movies WHERE users.id = userId AND movies.id = movieId AND users.id = ?', [id]);\n  let otherUsers = await db.all('SELECT name, id FROM users where id != ?', [id]);\n  let userSimilarity = []; // adding euclidean result here\n\n  /* Getting the similarity between users */\n\n  for (let i = 0; i < otherUsers.length; i++) {\n    let id = otherUsers[i]['id'];\n    let name = otherUsers[i]['name'];\n    /* Retrieve ratings for all the other users */\n\n    let otherUserRatings = await db.all('SELECT ratings.movieId, title, ratings.rating FROM ratings, users, movies WHERE users.id = userId AND movies.id = movieId AND users.id = ?', [id]);\n    let euclideanScore = await euclideanUser(userRatings, otherUserRatings); // get euclidean score\n\n    let wScore = await weightedScore(otherUserRatings, euclideanScore); // get weighter score\n\n    /* Push objects */\n\n    userSimilarity.push({\n      id: id,\n      user_name: name,\n      score: euclideanScore,\n      weighted_scores: wScore // high score = more similar\n\n    });\n  }\n  /* Push array with user objects */\n\n\n  user[0]['user_similarity'] = userSimilarity; // user = JSON.stringify(user, null, 2);\n\n  let x = user.map((y, i) => {\n    i++;\n  });\n  x = JSON.stringify(x, null, 2);\n  res.json(x);\n};\n\nexport default euclideanAPI;","map":{"version":3,"sources":["C:/Users/fredr/Documents/Universitet/HT20/2DV515 - Web Intelligence/A1/pages/api/euclidean/[id].ts"],"names":["sqlite3","require","sqlite","weightedScore","a","score","arr","i","length","wScore","push","movieId","title","euclideanUser","b","sim","n","j","inv","Math","round","toFixed","euclideanAPI","req","res","id","query","db","open","filename","driver","Database","user","all","userRatings","otherUsers","userSimilarity","name","otherUserRatings","euclideanScore","user_name","weighted_scores","x","map","y","JSON","stringify","json"],"mappings":"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","sourcesContent":["import { Console } from 'console';\r\nimport { NextApiRequest, NextApiResponse } from 'next';\r\nconst sqlite3 = require('sqlite3');\r\nconst sqlite = require('sqlite');\r\n\r\n/**\r\n * Calculating weighted score\r\n * @param a \r\n */\r\nconst weightedScore = async (a: any, score: number) => {\r\n    \r\n    let arr: Array<any> = [];\r\n\r\n    for (let i = 0; i < a.length; i++) {\r\n        let wScore: number = a[i]['rating'] * score;\r\n\r\n        arr.push({\r\n            movieId: a[i]['rating'],\r\n            title: a[i]['title'],\r\n            wScore: wScore\r\n        });\r\n\r\n    }\r\n\r\n    return arr;\r\n}\r\n \r\n/**\r\n * Calculating euclidean score\r\n * @param a \r\n * @param b \r\n */\r\nconst euclideanUser = async (a: any, b: any) => {\r\n    let sim: number = 0; // integer\r\n    let n: number = 0; //  counter for number of matching products\r\n\r\n    for (let i = 0; i < a.length; i++) {\r\n        for (let j = 0; j < b.length; j++) {\r\n\r\n            if (a[i]['movieId'] == b[j]['movieId']) {\r\n                sim += (a[i]['rating'] - b[j]['rating']) ** 2;\r\n                n += 1;\r\n            }\r\n\r\n        }\r\n    }\r\n\r\n    if (n == 0) {\r\n        return 0;\r\n    }\r\n\r\n    let inv: number = 1 / (1 + sim);\r\n\r\n    return (Math.round(inv * 100) / 100).toFixed(2);\r\n    // return inv;\r\n};\r\n\r\nconst euclideanAPI = async (req: NextApiRequest, res: NextApiResponse) => {\r\n    const id: any = req.query.id; // main user\r\n\r\n    /* DB connection */\r\n    const db = await sqlite.open({\r\n        filename: './mydb.sqlite',\r\n        driver: sqlite3.Database\r\n    });\r\n   \r\n    /* sql */\r\n    let user: any = await db.all('SELECT * FROM users where id = ?', [id]);\r\n    /* Retrieve ratings that belongs to main user */\r\n    let userRatings: any = await db.all('SELECT userId, movies.title, movieId, ratings.rating FROM ratings, users, movies WHERE users.id = userId AND movies.id = movieId AND users.id = ?', [id]);\r\n    let otherUsers: any = await db.all('SELECT name, id FROM users where id != ?', [id]);\r\n\r\n    let userSimilarity: Array<any> = []; // adding euclidean result here\r\n\r\n    /* Getting the similarity between users */\r\n    for (let i: number = 0; i < otherUsers.length; i++) {\r\n\r\n        let id: number = otherUsers[i]['id'];\r\n        let name: String = otherUsers[i]['name'];\r\n\r\n        /* Retrieve ratings for all the other users */\r\n        let otherUserRatings: any = await db.all('SELECT ratings.movieId, title, ratings.rating FROM ratings, users, movies WHERE users.id = userId AND movies.id = movieId AND users.id = ?', [id]);\r\n     \r\n        let euclideanScore: any = await euclideanUser(userRatings, otherUserRatings); // get euclidean score\r\n        let wScore: any = await weightedScore(otherUserRatings, euclideanScore); // get weighter score\r\n\r\n        /* Push objects */\r\n        userSimilarity.push({\r\n            id: id,\r\n            user_name: name,\r\n            score: euclideanScore,\r\n            weighted_scores: wScore // high score = more similar\r\n        });\r\n    }\r\n\r\n    /* Push array with user objects */\r\n    user[0]['user_similarity'] = userSimilarity;\r\n\r\n    // user = JSON.stringify(user, null, 2);\r\n\r\n    let x = user.map((y, i) => {\r\n        i++;\r\n    })\r\n    x = JSON.stringify(x, null, 2);\r\n\r\n    res.json(x);\r\n}\r\n\r\nexport default euclideanAPI;"]},"metadata":{},"sourceType":"module"}